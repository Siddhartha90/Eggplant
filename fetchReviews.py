from serpapi import GoogleSearch
import json
import ast
from sentimentAnalysis import sentimentAnalysis

# Fetches only the first 10 reviews.
def fetchReviews(restaurantId, keyword):
    print("here - " + restaurantId)
    params = {
      "engine": "google_maps_reviews",
      "data_id": restaurantId,
      "api_key": "b37d293807a175ad5d3f548b99d2552c5961eb8067f8350312b48aca2c1a9db6"
    }
    search = GoogleSearch(params)
    results = search.get_dict()
    reviews = results["reviews"]
    search_metadata = results["search_metadata"]
    embedded_url = search_metadata["raw_html_file"]
    # print(embedded_url)
    # reviews = "[{'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSUNCbmNURHB3RRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgICBncTDpwE%7CCgwI4-LInQYQqP__8wE%7C?hl=en-US', 'user': {'name': 'J', 'link': 'https://www.google.com/maps/contrib/117052627970411506808?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegQIARBB', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMTo36MauxHZVt1DOOn5ejOmwQIe41eWJRZjgpjy6w=s40-c-c0x00000000-cc-rp-mo-ba5-br100', 'local_guide': True, 'reviews': 198, 'photos': 780}, 'rating': 5.0, 'date': '4 months ago', 'snippet': 'Good was served quickly. The noodles were cooked very nicely and the sauce for each meal was very delicious. Prosciutto with bruschetta cheese was very delicious also. Note: They charge extra for olives.', 'likes': 2, 'images': ['https://lh5.googleusercontent.com/p/AF1QipMSdRpEx033odu0bBT1aH08Zl5CKt-RTnw62JSJ=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipMWT0m-jF2HRC601XLdtvZ_nDpidSnWrEgSC-zO=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPVT-bRE-QVaDWgxI0a_F6C44UxxUIjNbj4sraC=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipOvms7M6AsuXsznYdWGH7bt_Nq0AFcpymHECqFk=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPVHYh_kyxPn9wWaXUQdtrKc6tcRkjYt9lpRIBH=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSURXcy0tZW1nRRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDWs--emgE%7CCgsIhd6nkgYQyL_YVg%7C?hl=en-US', 'user': {'name': 'Mimi Hsu', 'link': 'https://www.google.com/maps/contrib/107486060213016544633?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegQIARB3', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMTibEMET0UkkNhdrRBxUKv1EKQHFACDKl0VuI0_kg=s40-c-c0x00000000-cc-rp-mo-ba7-br100', 'local_guide': True, 'reviews': 754, 'photos': 10176}, 'rating': 5.0, 'date': 'a year ago', 'snippet': 'Found this place on Google because we were looking for Gluten Free Pizzaâ€¦.and they had it! Indoor and outdoor dining options. The outdoor is covered so even though it was slightly chilly, you didnâ€™t feel the wind. All the restaurants down this block and the next were all Italian restaurants. The staff was extremely friendly and the food came out so fast. Everything tasted so good and fresh. We enjoyed everything we ordered and would be happy to try this place out again the next time we visit.', 'likes': 3, 'images': ['https://lh5.googleusercontent.com/p/AF1QipMjxScSi46ZAkg9GJ89xTxXy42VasqnrA_p70z4=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPhxcmyNbepiy0e3x2FSMlj186I30KYFbQC0t-E=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipOzduAc6c317gNVGsl5VcaEIa8n5lbtDfHn0MIU=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipNDkvn_DqLh1krRHBHCJAs5pWOPxyDNLzZNVbDk=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipMqwiQVgtDHcQ2Sx1qRPrbsi-cpK4wBdOk1LgxO=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPPCQ5zxVejwrO5X9emPuUqza6lQ1r7JeDp8-7T=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipMfjsqixX-6PwJ5LdE0xt-RWjTWcADrm5fHw0A6=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSURoNE5pRnF3RRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDh4NiFqwE%7CCgwI5ZXwnwYQ0JW4vQE%7C?hl=en-US', 'user': {'name': 'Clarisse BSL', 'link': 'https://www.google.com/maps/contrib/114387147461937209172?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARC5AQ', 'thumbnail': 'https://lh3.googleusercontent.com/a/AAcHTtdB1Tw4TxwmDMR82EzH48FH7JwvXW9gpNksOolc=s40-c-c0x00000000-cc-rp-mo-ba3-br100', 'local_guide': True, 'reviews': 25, 'photos': 76}, 'rating': 4.0, 'date': '3 months ago', 'snippet': 'The men who seem to be the owners are nice and genuinely Italian. The place is warm and quite small which can be an indicator of home-made cuisine. But also a little noisy. The service was a little long. Lasagnas are good, better than the carbonara that could use a little more meat. Overall it was good but not unforgettable. But the quality/price ratio is good, especially in comparison with the competitors.', 'likes': 2, 'images': ['https://lh5.googleusercontent.com/p/AF1QipPsbhOp36dtSijdOFdIaQ9hZbfTALVX8OpGunBD=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPB3ZYIs41mFvu1-alfEcA09OxBeymFvkxXWzsP=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSURXcXN2VDJ3RRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDWqsvT2wE%7CCgwI_6bgkQYQsKGQjgE%7C?hl=en-US', 'user': {'name': 'Kushal Pawar', 'link': 'https://www.google.com/maps/contrib/102979744968275688793?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARDqAQ', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMQ3pzxa1HlZ06nTByY0a3e3dZNcI-SbPBjwgYBU4A=s40-c-c0x00000000-cc-rp-mo-ba4-br100', 'local_guide': True, 'reviews': 104, 'photos': 171}, 'rating': 5.0, 'date': 'a year ago', 'snippet': 'Came here a few Fridayâ€™s ago and it was amazing! We waited about 15 mins for a table, on a Friday evening which was really good timing. The food here was delicious! I had the lasagna and pizza, both were fantastic. The lasagna was very sauce and flavorful and pizza was a nice thin crust with great toppings', 'likes': 6, 'images': ['https://lh5.googleusercontent.com/p/AF1QipObB7znPEVd1NRHcVMABpmG4Nf4YOyNt7yby0n3=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipMCUcRWzxz98ISqyHfObQOrRYL0kOY9HdrAGXsl=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSUNPeXJ1c2d3RRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgICOyrusgwE%7CCgwI77H6lAYQkIW60wE%7C?hl=en-US', 'user': {'name': 'Renee Anderson', 'link': 'https://www.google.com/maps/contrib/103104946920608220324?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARCFAg', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMRZlxLDXtHC_j18POyXNFFdlz3i9ceL3wtDBj51=s40-c-c0x00000000-cc-rp-mo-br100', 'reviews': 15, 'photos': 3}, 'rating': 5.0, 'date': '11 months ago', 'snippet': 'Absolutely delicious ðŸ¤¤. We ordered pizza, ravioli with mushroom and truffle sauce and the homemade gnocchi. All three meals were so tasty and amazing flavours, our favourite though would have to be the ravioli, this was mouth watering, drop dead delicious. All meals were priced extremely well, and when we ordered dessert our waiter gave us it on the house just to be generous. We will definitely be back here. Thank you!!!', 'likes': 1, 'images': ['https://lh5.googleusercontent.com/p/AF1QipOllYsMEaPogPkJlL-h73KHzpi_qrdFrRmJ9BAw=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipO7l4Zrtp43KLcNt0aYli98ZvpjC3dTHg5_RQKL=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipO-vevn92tPd-qtZAyzAc29Qgq57MYfjO4DTFn0=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSUNPcHB5RGlRRRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgICOppyDiQE%7CCgwIxaWDlQYQ8MHl7wI%7C?hl=en-US', 'user': {'name': 'Raoul Gabiam', 'link': 'https://www.google.com/maps/contrib/105016516458649886214?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARChAg', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMQslfQFUcK-bwLc7ongdTrMHt5UJdhZXTh7RZdK=s40-c-c0x00000000-cc-rp-mo-ba5-br100', 'local_guide': True, 'reviews': 133, 'photos': 1622}, 'rating': 4.0, 'date': '11 months ago', 'snippet': 'Awesome little Italian restaurant. Food was delicious. And very reasonably priced, generous portions. Great staff and service. They have outdoor seating as well.', 'images': ['https://lh5.googleusercontent.com/p/AF1QipO3pfXGklcTo0EkpJlRJ54sgp5ISneadJLpOtda=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPkLFixGXHvrPLu9NNHPm_4C-FzpPkTMztC8AW8=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipNzReLT1thehJ2O855eM4e3rk5MGq0BPu6qmpeE=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPrVXFeKHkBIwskAx4E2tZxKtKn8w3cKEt3QGAf=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipNBHPEjYb7lC753YRnLKFhQ0uf7x3KMwNBc3TC6=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChdDSUhNMG9nS0VJQ0FnSURXb3ZHV19BRRAB!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDWovGW_AE%7CCgsImJjWkQYQ2JzsTg%7C?hl=en-US', 'user': {'name': 'Ash Ley', 'link': 'https://www.google.com/maps/contrib/111939450214772409707?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARDNAg', 'thumbnail': 'https://lh3.googleusercontent.com/a/AAcHTte2o2-6iqFes_C6hfeBOw1X7MkM0NCZzbeCC7BUaQ=s40-c-c0x00000000-cc-rp-mo-ba5-br100', 'local_guide': True, 'reviews': 164, 'photos': 548}, 'rating': 5.0, 'date': 'a year ago', 'snippet': 'Very yummy and great service! Waiter was super funny and very kind. Very nice hip place small but there is seating inside and outside as well with those heat lamps. Great menu great food great service great location what more can you ask for.', 'images': ['https://lh5.googleusercontent.com/p/AF1QipM1xkoerpdi6cGxrcizetvfrThvfg43dLQjEP5h=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipO9IzAEAjXsAwRba2RyBObpqsX30lbacTzkVIBe=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPj84tL8snxI9IqKT-EUC1-RZ5Zlz7Ia4fRca6w=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPytwjFf7WLi5ha977FXLpkMfvCnz3qu7Sz8zeW=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPVx9FCHkuGyW-vMzc4DKOe1_pgHJi0JjbG4tjJ=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPIO3sko_0HQPLM6eCZ8Q08XYUotxmzGSviaD82=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChZDSUhNMG9nS0VJQ0FnSURoaS1iWFh3EAE!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDhi-bXXw%7CCgsItKbSoAYQyLaCSg%7C?hl=en-US', 'user': {'name': 'Samuel Magni', 'link': 'https://www.google.com/maps/contrib/108218851445873565378?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARCGAw', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMTDOCap1ahqxPAp0du8b70gY_xuvHcuAXX6itk4kA=s40-c-c0x00000000-cc-rp-mo-ba3-br100', 'local_guide': True, 'reviews': 28, 'photos': 33}, 'rating': 5.0, 'date': '2 months ago', 'snippet': 'Very good Italian restaurant in little Italy, recommended for families. If you want to try Italian cuisine go here! friendly and super trained staff. i will be back', 'images': ['https://lh5.googleusercontent.com/p/AF1QipMtSYItKhjMApTxYGDvDBnfEk1jG8_FgmVrVVRC=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipMKNzkYffyIeBGuabY0PNXixRozuyvyLnH2bkho=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipP9bXSXMvhm28zupw03DckpRoXiKwC5fILMmOn2=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChZDSUhNMG9nS0VJQ0FnSUR1d0tpR2NREAE!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgIDuwKiGcQ%7CCgsI_JPPlwYQqJeGHw%7C?hl=en-US', 'user': {'name': 'Kerry Dowdle', 'link': 'https://www.google.com/maps/contrib/105676582364319525019?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARC2Aw', 'thumbnail': 'https://lh3.googleusercontent.com/a-/AD_cMMQ79AGMhY8tihjG6D3PQU_9aRzBmkix61rinNIlUA=s40-c-c0x00000000-cc-rp-mo-br100', 'reviews': 41, 'photos': 64}, 'rating': 5.0, 'date': '9 months ago', 'snippet': 'Best Italian food ever! The service was good. The food was absolutely phenomenal, not sure I can ever have another pizza without longing for theirs. we got the margarita pinsa and the penne piccolo forno. The have both outdoor and indoor seating.', 'images': ['https://lh5.googleusercontent.com/p/AF1QipM0HkRh8iCwSPjk-jHjW44lKK-CzZAedZv3HuO5=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPmCI3eKgRq7mI9u9fyGUUvJO3i0RnaW9Lr9GBP=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipNJZsOqvQK-byaQ5xEdSY4-sSZau7kpFcB778d8=w100-h100-p-n-k-no']}, {'link': 'https://www.google.com/maps/reviews/data=!4m8!14m7!1m6!2m5!1sChZDSUhNMG9nS0VJQ0FnSUNlckt6Yk5REAE!2m1!1s0x0:0x62dc2642b0573fea!3m1!1s2@1:CIHM0ogKEICAgICerKzbNQ%7CCgwIn53lmAYQiKTWrgM%7C?hl=en-US', 'user': {'name': 'Cassie Guy', 'link': 'https://www.google.com/maps/contrib/110736259628776324854?hl=en-US&sa=X&ved=2ahUKEwjOsorz65b_AhXmFFkFHa4DC2UQvvQBegUIARDSAw', 'thumbnail': 'https://lh3.googleusercontent.com/a/AAcHTtexa2C2Rs7VmPROwkgn0ZMXih99gFBu6CArUQO_=s40-c-c0x00000000-cc-rp-mo-br100', 'reviews': 6, 'photos': 4}, 'rating': 5.0, 'date': '8 months ago', 'snippet': 'This place is amazing. Great recommendations. Kids (7&9) shared a Carbonara, more than sufficient. Ragu and ravioli fungi were amazing. Desserts are all fantastic. Good wine, good service.', 'images': ['https://lh5.googleusercontent.com/p/AF1QipNmY91WwDJ_88SzP40iz_ESPQtqDK6FEpHxbeNf=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPh6QEU6pDC0_AhpJg3tUvetUy7lrDzCTXUzahK=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipPvvat5W5I5vrGjxRu744W-AbWbKCPWz6rDPhmY=w100-h100-p-n-k-no', 'https://lh5.googleusercontent.com/p/AF1QipN2_nv4lCq4-rO4X0mmdXkJ1If5hTpUBPUhbF00=w100-h100-p-n-k-no']}]"
    reviews_sanitized = ast.literal_eval(str(reviews))
    reviews_output = ""
    i = 0
    for restaurant in reviews_sanitized:
        reviews_output = reviews_output + str(i) + ": "
        review = restaurant["snippet"]
        reviews_output = reviews_output + review + "</br>"
        # print(restaurant["snippet"])
        i = i + 1

    sentiment = sentimentAnalysis(reviews_output, keyword)
    return "<p> Sentiment based on" + i + " reviews: " + sentiment + "</p>"
    # return "<iframe src=\"" + embedded_url + "\" title=\"description\"></iframe>"

# Fetches given number of reviews pages, each page has 10
def fetchReviews(restaurantId, numPages:10, keyword):       
    results = ""
    reviewsAccountedFor = 0
    reviews_output = ""
    for x in range(numPages):
        print("MAKING PAGE CALL - " + str(x))
        if x == 0:
            params = {
              "engine": "google_maps_reviews",
              "data_id": restaurantId,
              "api_key": "b37d293807a175ad5d3f548b99d2552c5961eb8067f8350312b48aca2c1a9db6",
            }
        else:
            next_page_token = results["serpapi_pagination"]["next_page_token"]
            if next_page_token is None:
                break;

            params = {
              "engine": "google_maps_reviews",
              "data_id": restaurantId,
              "api_key": "b37d293807a175ad5d3f548b99d2552c5961eb8067f8350312b48aca2c1a9db6",
              "next_page_token": next_page_token
            }
        
        search = GoogleSearch(params)
        results = search.get_dict()
        reviews = results["reviews"]
        reviews_sanitized = ast.literal_eval(str(reviews))        
        for restaurant in reviews_sanitized:
            reviews_output = reviews_output + str(reviewsAccountedFor) + ": "
            review = restaurant["snippet"]
            reviews_output = reviews_output + review + "\n"
            reviewsAccountedFor = reviewsAccountedFor + 1

    sentimentJson = sentimentAnalysis()
    result = {'sentiment': sentimentJson, reviewsAccountedFor: reviewsAccountedFor}
    return result
